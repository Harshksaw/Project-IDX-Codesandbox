services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.server
    container_name: codeexpo-backend
    ports:
      - "50002:50002"
      - "50003:50003"
      - "50004:50004"
    environment:
      - NODE_ENV=production
      - PORT=50002
      - TERMINAL_PORT=50003
      - PREVIEW_PORT=50004
      # HOST_PROJECTS_PATH is the path on the HOST machine where projects are stored
      # This is needed for sibling containers to mount the correct path
      - HOST_PROJECTS_PATH=${PWD}/projects
      - SANDBOX_NETWORK=codeexpo-network
    volumes:
      # Mount Docker socket for container management (Docker-out-of-Docker)
      - /var/run/docker.sock:/var/run/docker.sock
      # Persist projects - mount host path into backend container
      - ./projects:/app/projects
    restart: unless-stopped
    networks:
      - codeexpo-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:50002/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # No VITE_BACKEND_URL / VITE_TERMINAL_URL args = frontend uses relative URLs
      # routed through nginx to the backend services (production mode)
    container_name: codeexpo-frontend
    ports:
      - "50001:80"
      # - "443:443"  # Uncomment for HTTPS
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - codeexpo-network
    # healthcheck disabled - container was being killed

  # Sandbox base image builder (run once to build the sandbox image)
  # Usage: docker-compose --profile build-sandbox build sandbox-builder
  sandbox-builder:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: sandbox:latest
    profiles:
      - build-sandbox

networks:
  codeexpo-network:
    name: codeexpo-network
    driver: bridge
