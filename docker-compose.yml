version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.server
    container_name: codeexpo-backend
    ports:
      - "50002:50002"
      - "50003:50003"
    environment:
      - NODE_ENV=production
      - PORT=50002
      - TERMINAL_PORT=50003
      # HOST_PROJECTS_PATH is the path on the HOST machine where projects are stored
      # This is needed for sibling containers to mount the correct path
      - HOST_PROJECTS_PATH=${PWD}/projects
    volumes:
      # Mount Docker socket for container management (Docker-out-of-Docker)
      - /var/run/docker.sock:/var/run/docker.sock
      # Persist projects - mount host path into backend container
      - ./projects:/app/projects
    restart: unless-stopped
    networks:
      - codeexpo-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_BACKEND_URL=
    container_name: codeexpo-frontend
    ports:
      - "50001:80"
      # - "443:443"  # Uncomment for HTTPS
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - codeexpo-network

  # Sandbox base image builder (run once to build the sandbox image)
  # Usage: docker-compose --profile build-sandbox build sandbox-builder
  sandbox-builder:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: sandbox:latest
    profiles:
      - build-sandbox

networks:
  codeexpo-network:
    driver: bridge
